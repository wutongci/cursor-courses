# 第二章 接口测试驱动开发

## 2.1 RESTful API 测试基础

### 2.1.1 API 测试的重要性
在现代微服务架构中，API 测试尤为重要：
- 确保接口功能正确性
- 验证数据交互的准确性
- 保证系统集成的可靠性
- 提高开发效率和质量

### 2.1.2 API 测试用例的组成
一个完整的 API 测试用例应包含：
```python
{
    "name": "创建用户接口测试",
    "method": "POST",
    "endpoint": "/api/v1/users",
    "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer ${token}"
    },
    "request_body": {
        "username": "test_user",
        "email": "test@example.com",
        "password": "Test123!"
    },
    "expected_status": 201,
    "expected_response": {
        "success": true,
        "data": {
            "id": "string",
            "username": "test_user",
            "email": "test@example.com"
        }
    }
}
```

## 2.2 编写高质量 API 测试用例

### 2.2.1 测试用例设计原则
1. 完整性：覆盖所有请求方法和参数
2. 独立性：测试用例之间互不影响
3. 可重复性：测试结果可重现
4. 可维护性：结构清晰，易于更新

### 2.2.2 常见测试场景
```python
class TestUserAPI:
    """用户管理 API 测试用例"""
    
    def test_create_user(self):
        """测试创建用户"""
        response = client.post("/api/v1/users", json={
            "username": "test_user",
            "email": "test@example.com",
            "password": "Test123!"
        })
        assert response.status_code == 201
        assert response.json()["success"] is True
        
    def test_get_user(self):
        """测试获取用户信息"""
        response = client.get("/api/v1/users/123")
        assert response.status_code == 200
        assert "username" in response.json()["data"]
        
    def test_update_user(self):
        """测试更新用户信息"""
        response = client.put("/api/v1/users/123", json={
            "username": "new_username"
        })
        assert response.status_code == 200
        assert response.json()["data"]["username"] == "new_username"
        
    def test_delete_user(self):
        """测试删除用户"""
        response = client.delete("/api/v1/users/123")
        assert response.status_code == 204
```

### 2.2.3 参数化测试
```python
@pytest.mark.parametrize("email,password,expected_status", [
    ("valid@email.com", "Valid123!", 201),
    ("invalid-email", "Valid123!", 400),
    ("valid@email.com", "short", 400),
    ("", "Valid123!", 400),
    ("valid@email.com", "", 400),
])
def test_user_registration_validation(email, password, expected_status):
    """测试用户注册参数验证"""
    response = client.post("/api/v1/users", json={
        "email": email,
        "password": password
    })
    assert response.status_code == expected_status
```

## 2.3 实战：订单管理系统接口开发

### 2.3.1 系统需求
开发一个订单管理系统的 RESTful API，包含：
- 订单创建
- 订单查询
- 订单更新
- 订单取消
- 订单支付状态管理

### 2.3.2 API 测试用例
```python
class TestOrderAPI:
    """订单管理 API 测试用例"""
    
    def test_create_order(self):
        """测试创建订单"""
        order_data = {
            "user_id": "user_123",
            "items": [
                {"product_id": "prod_1", "quantity": 2},
                {"product_id": "prod_2", "quantity": 1}
            ],
            "shipping_address": {
                "street": "123 Test St",
                "city": "Test City",
                "country": "Test Country"
            }
        }
        
        response = client.post("/api/v1/orders", json=order_data)
        assert response.status_code == 201
        assert response.json()["success"] is True
        assert "order_id" in response.json()["data"]
        
    def test_get_order(self):
        """测试获取订单详情"""
        response = client.get("/api/v1/orders/order_123")
        assert response.status_code == 200
        assert response.json()["data"]["status"] in ["pending", "paid", "shipped"]
        
    def test_update_order_status(self):
        """测试更新订单状态"""
        response = client.patch("/api/v1/orders/order_123", json={
            "status": "paid"
        })
        assert response.status_code == 200
        assert response.json()["data"]["status"] == "paid"
        
    def test_cancel_order(self):
        """测试取消订单"""
        response = client.post("/api/v1/orders/order_123/cancel")
        assert response.status_code == 200
        assert response.json()["data"]["status"] == "cancelled"
        
    def test_order_payment(self):
        """测试订单支付"""
        payment_data = {
            "amount": 99.99,
            "currency": "USD",
            "payment_method": "credit_card",
            "card_token": "tok_123"
        }
        
        response = client.post(
            "/api/v1/orders/order_123/pay",
            json=payment_data
        )
        assert response.status_code == 200
        assert response.json()["data"]["payment_status"] == "completed"
```

### 2.3.3 使用测试用例引导 AI 开发
1. 基于测试用例生成 API 实现：
```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional

app = FastAPI()

class OrderItem(BaseModel):
    product_id: str
    quantity: int

class Address(BaseModel):
    street: str
    city: str
    country: str

class OrderCreate(BaseModel):
    user_id: str
    items: List[OrderItem]
    shipping_address: Address

@app.post("/api/v1/orders")
async def create_order(order: OrderCreate):
    # AI 根据测试用例生成具体实现
    order_id = generate_order_id()
    total_amount = calculate_total(order.items)
    
    new_order = {
        "id": order_id,
        "user_id": order.user_id,
        "items": order.items,
        "shipping_address": order.shipping_address,
        "status": "pending",
        "total_amount": total_amount
    }
    
    save_order(new_order)
    
    return {
        "success": True,
        "data": {"order_id": order_id}
    }

# ... 其他接口实现
```

## 2.4 最佳实践与注意事项

### 2.4.1 API 测试要点
1. 接口规范性测试
   - URL 格式
   - HTTP 方法使用
   - 状态码规范
   - 响应格式

2. 功能完整性测试
   - 必填参数验证
   - 可选参数处理
   - 业务逻辑验证
   - 数据一致性

3. 异常处理测试
   - 参数错误处理
   - 业务异常处理
   - 系统异常处理
   - 超时处理

### 2.4.2 常见问题与解决方案
1. 测试数据管理
   - 使用工厂模式创建测试数据
   - 测试数据隔离
   - 数据清理策略

2. 测试环境管理
   - 环境变量配置
   - 测试数据库管理
   - Mock 服务管理

3. 测试效率提升
   - 并行测试执行
   - 测试用例组织
   - 测试报告生成

## 2.5 小结

本章介绍了如何通过接口测试来驱动 API 开发：
1. 掌握 API 测试的基础知识
2. 学会编写高质量的 API 测试用例
3. 通过实战项目理解接口测试驱动开发
4. 了解 API 测试的最佳实践

在下一章中，我们将探讨如何通过性能测试来驱动系统优化。

---
[回到目录](../README.md)

上一章：[第一章-通过测试用例引导AI开发](第一章-通过测试用例引导AI开发.md)

下一章：[第三章-性能测试驱动优化](第三章-性能测试驱动优化.md)
